<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–ö–æ—Å–º–µ—Ç–æ–ª–æ–≥—ñ—á–Ω–∏–π –∞–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä –º—ñ–º—ñ–∫–∏ Pro</title>
  
  <!-- –®—Ä–∏—Ñ—Ç–∏ -->
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg-dark: #121212;
      --bg-card: rgba(30, 30, 30, 0.9);
      --gold-accent: #d4a373;
      --gold-bright: #e8c66e;
      --text-light: #f5f5f5;
      --font-heading: 'Cormorant Garamond', serif;
      --font-body: 'Open Sans', sans-serif;
      --shadow-lg: 0 15px 35px rgba(0,0,0,0.6);
      --shadow-md: 0 8px 25px rgba(0,0,0,0.4);
      --transition: all 0.3s ease;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: var(--font-body);
      background-color: var(--bg-dark);
      color: var(--text-light);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
      flex: 1;
    }
    
    .header {
      text-align: center;
      padding: 30px 15px;
      background: linear-gradient(135deg, #1a1a1a, #0a0a0a);
      border-radius: 0 0 40px 40px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-lg);
    }
    
    .header h1 {
      font-size: 32px;
      color: var(--gold-accent);
      font-family: var(--font-heading);
      letter-spacing: 1px;
    }
    
    .header p {
      font-size: 18px;
      max-width: 600px;
      margin: 15px auto 0;
    }
    
    .camera-card {
      background: var(--bg-card);
      backdrop-filter: blur(5px);
      border: 2px solid var(--gold-accent);
      border-radius: 30px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: var(--shadow-md);
    }
    
    .video-wrapper {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      border-radius: 20px;
      overflow: hidden;
      aspect-ratio: 4 / 3;
      background: #2a2a2a;
    }
    
    #video, #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin: 20px 0 10px;
    }
    
    .btn {
      padding: 10px 20px;
      background: transparent;
      border: 2px solid var(--gold-accent);
      color: var(--gold-accent);
      font-family: var(--font-heading);
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 1px;
      cursor: pointer;
      border-radius: 40px;
      transition: var(--transition);
    }
    
    .btn:hover {
      background: var(--gold-accent);
      color: #121212;
    }
    
    .btn.small {
      padding: 6px 12px;
      font-size: 14px;
    }
    
    .btn.primary {
      background: var(--gold-accent);
      color: #121212;
    }
    
    .btn.primary:hover {
      background: transparent;
      color: var(--gold-accent);
    }
    
    .status {
      text-align: center;
      font-size: 16px;
      margin-top: 15px;
      padding: 10px;
      background: #2a2a2a;
      border-radius: 30px;
      color: var(--gold-accent);
    }
    
    /* –ú–µ—Ç—Ä–∏–∫–∏ */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 15px;
      margin: 30px 0;
    }
    
    .metric-card {
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid var(--gold-accent);
      border-radius: 25px;
      padding: 15px;
      text-align: center;
    }
    
    .metric-card h3 {
      color: var(--gold-accent);
      font-family: var(--font-heading);
      font-size: 18px;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--gold-accent);
      padding-bottom: 5px;
    }
    
    .value {
      font-size: 32px;
      font-weight: 600;
      color: var(--gold-bright);
      line-height: 1.2;
    }
    
    .unit {
      font-size: 14px;
      opacity: 0.8;
    }
    
    .max-value {
      margin-top: 5px;
      font-size: 14px;
    }
    
    .max-value span {
      color: var(--gold-accent);
      font-weight: 600;
    }
    
    /* –ì—Ä–∞—Ñ—ñ–∫ */
    .graph-container {
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid var(--gold-accent);
      border-radius: 25px;
      padding: 20px;
      margin: 30px 0;
    }
    
    .graph-container h3 {
      color: var(--gold-accent);
      font-family: var(--font-heading);
      font-size: 22px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    #graphCanvas {
      width: 100%;
      height: auto;
      background: #1e1e1e;
      border-radius: 15px;
      display: block;
    }
    
    /* –§–æ—Ç–æ –¥–æ/–ø—ñ—Å–ª—è */
    .photo-compare {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin: 30px 0;
    }
    
    .photo-card {
      flex: 1 1 250px;
      background: rgba(20, 20, 20, 0.8);
      border: 1px solid var(--gold-accent);
      border-radius: 25px;
      padding: 15px;
      text-align: center;
    }
    
    .photo-card img {
      width: 100%;
      border-radius: 15px;
      border: 2px solid var(--gold-accent);
      background: #2a2a2a;
      min-height: 150px;
    }
    
    .photo-card .btn {
      margin-top: 10px;
    }
    
    /* –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è */
    .instructions {
      background: rgba(212,163,115,0.1);
      border-radius: 30px;
      padding: 25px;
      margin: 30px 0;
    }
    
    .instructions h3 {
      color: var(--gold-accent);
      margin-bottom: 15px;
    }
    
    .instructions ul {
      list-style: none;
    }
    
    .instructions li {
      margin-bottom: 10px;
      padding-left: 24px;
      position: relative;
    }
    
    .instructions li::before {
      content: '‚úì';
      color: var(--gold-accent);
      position: absolute;
      left: 0;
    }
    
    .footer {
      text-align: center;
      padding: 30px 20px;
      background: #1a1a1a;
      border-top: 2px solid var(--gold-accent);
      margin-top: 50px;
    }
    
    @media (min-width: 768px) {
      .btn { font-size: 18px; padding: 12px 28px; }
      .metrics-grid { grid-template-columns: repeat(3, 1fr); }
    }
    
    @media (min-width: 1024px) {
      .metrics-grid { grid-template-columns: repeat(6, 1fr); }
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üî¨ –ê–Ω–∞–ª—ñ–∑–∞—Ç–æ—Ä –º—ñ–º—ñ–∫–∏ Pro</h1>
    <p>–í–∏–º—ñ—Ä—é–≤–∞–Ω–Ω—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ –º'—è–∑—ñ–≤ –æ–±–ª–∏—á—á—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º—É —á–∞—Å—ñ</p>
  </div>
  
  <div class="container">
    <!-- –ö–∞–º–µ—Ä–∞ —Ç–∞ –æ—Å–Ω–æ–≤–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è -->
    <div class="camera-card">
      <div class="video-wrapper">
        <video id="video" playsinline autoplay muted></video>
        <canvas id="canvas"></canvas>
      </div>
      
      <div class="controls">
        <button class="btn" id="startBtn">‚ñ∂ –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–∞–º–µ—Ä—É</button>
        <button class="btn" id="calibrateBtn">‚öôÔ∏è –ö–∞–ª—ñ–±—Ä—É–≤–∞—Ç–∏ —Å–ø–æ–∫—ñ–π</button>
        <button class="btn" id="resetMaxBtn">üîÑ –°–∫–∏–Ω—É—Ç–∏ –º–∞–∫—Å–∏–º—É–º–∏</button>
        <button class="btn" id="saveSessionBtn">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ —Å–µ—Å—ñ—é</button>
      </div>
      
      <div class="status" id="status">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∑–∞–ø—É—Å–∫—É –∫–∞–º–µ—Ä–∏...</div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å –∑ 6 –º–µ—Ç—Ä–∏–∫–∞–º–∏ -->
    <div class="metrics-grid" id="metricsGrid">
      <!-- –õ—ñ–≤–∞ –±—Ä–æ–≤–∞ -->
      <div class="metric-card">
        <h3>–õ—ñ–≤–∞ –±—Ä–æ–≤–∞</h3>
        <div class="value" id="browLeftValue">0.00</div>
        <div class="unit">–Ω–æ—Ä–º. –ø—ñ–∫—Å.</div>
        <div class="max-value">–ú–∞–∫—Å: <span id="browLeftMax">0.00</span></div>
      </div>
      <!-- –ü—Ä–∞–≤–∞ –±—Ä–æ–≤–∞ -->
      <div class="metric-card">
        <h3>–ü—Ä–∞–≤–∞ –±—Ä–æ–≤–∞</h3>
        <div class="value" id="browRightValue">0.00</div>
        <div class="unit">–Ω–æ—Ä–º. –ø—ñ–∫—Å.</div>
        <div class="max-value">–ú–∞–∫—Å: <span id="browRightMax">0.00</span></div>
      </div>
      <!-- –õ—ñ–≤–µ –æ–∫–æ (–ø—Ä–∏–º—É—Ä–∂—É–≤–∞–Ω–Ω—è) -->
      <div class="metric-card">
        <h3>–õ—ñ–≤–µ –æ–∫–æ (–ø—Ä–∏–º.)</h3>
        <div class="value" id="eyeLeftValue">0.00</div>
        <div class="unit">–Ω–æ—Ä–º. –ø—ñ–∫—Å.</div>
        <div class="max-value">–ú–∞–∫—Å: <span id="eyeLeftMax">0.00</span></div>
      </div>
      <!-- –ü—Ä–∞–≤–µ –æ–∫–æ (–ø—Ä–∏–º—É—Ä–∂—É–≤–∞–Ω–Ω—è) -->
      <div class="metric-card">
        <h3>–ü—Ä–∞–≤–µ –æ–∫–æ (–ø—Ä–∏–º.)</h3>
        <div class="value" id="eyeRightValue">0.00</div>
        <div class="unit">–Ω–æ—Ä–º. –ø—ñ–∫—Å.</div>
        <div class="max-value">–ú–∞–∫—Å: <span id="eyeRightMax">0.00</span></div>
      </div>
      <!-- –õ—ñ–≤–∏–π –∫—É—Ç–æ—á–æ–∫ —Ä–æ—Ç–∞ -->
      <div class="metric-card">
        <h3>–õ—ñ–≤–∏–π –∫—É—Ç–æ—á–æ–∫ —Ä–æ—Ç–∞</h3>
        <div class="value" id="mouthLeftValue">0.00</div>
        <div class="unit">–Ω–æ—Ä–º. –ø—ñ–∫—Å.</div>
        <div class="max-value">–ú–∞–∫—Å: <span id="mouthLeftMax">0.00</span></div>
      </div>
      <!-- –ü—Ä–∞–≤–∏–π –∫—É—Ç–æ—á–æ–∫ —Ä–æ—Ç–∞ -->
      <div class="metric-card">
        <h3>–ü—Ä–∞–≤–∏–π –∫—É—Ç–æ—á–æ–∫ —Ä–æ—Ç–∞</h3>
        <div class="value" id="mouthRightValue">0.00</div>
        <div class="unit">–Ω–æ—Ä–º. –ø—ñ–∫—Å.</div>
        <div class="max-value">–ú–∞–∫—Å: <span id="mouthRightMax">0.00</span></div>
      </div>
    </div>
    
    <!-- –ì—Ä–∞—Ñ—ñ–∫ –¥–∏–Ω–∞–º—ñ–∫–∏ -->
    <div class="graph-container">
      <h3>üìà –î–∏–Ω–∞–º—ñ–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (–æ—Å—Ç–∞–Ω–Ω—ñ 100 –∫–∞–¥—Ä—ñ–≤)</h3>
      <canvas id="graphCanvas" width="800" height="200"></canvas>
    </div>
    
    <!-- –§–æ—Ç–æ –¥–æ/–ø—ñ—Å–ª—è -->
    <div class="photo-compare">
      <div class="photo-card">
        <h3>üì∏ –î–æ</h3>
        <img id="photoBefore" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150' viewBox='0 0 200 150'%3E%3Crect width='200' height='150' fill='%232a2a2a'/%3E%3Ctext x='50' y='75' fill='%23d4a373' font-family='Arial' font-size='14'%3E–ù–µ–º–∞—î —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E" alt="Before">
        <button class="btn small" id="photoBeforeBtn">–ó—Ä–æ–±–∏—Ç–∏ –∑–Ω—ñ–º–æ–∫ "–î–æ"</button>
      </div>
      <div class="photo-card">
        <h3>üì∏ –ü—ñ—Å–ª—è</h3>
        <img id="photoAfter" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150' viewBox='0 0 200 150'%3E%3Crect width='200' height='150' fill='%232a2a2a'/%3E%3Ctext x='50' y='75' fill='%23d4a373' font-family='Arial' font-size='14'%3E–ù–µ–º–∞—î —Ñ–æ—Ç–æ%3C/text%3E%3C/svg%3E" alt="After">
        <button class="btn small" id="photoAfterBtn">–ó—Ä–æ–±–∏—Ç–∏ –∑–Ω—ñ–º–æ–∫ "–ü—ñ—Å–ª—è"</button>
      </div>
    </div>
    
    <!-- –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è -->
    <div class="instructions">
      <h3>üìã –Ø–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—å</h3>
      <ul>
        <li><strong>1.</strong> –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ó–∞–ø—É—Å—Ç–∏—Ç–∏ –∫–∞–º–µ—Ä—É" —Ç–∞ –¥–æ–∑–≤–æ–ª—å—Ç–µ –¥–æ—Å—Ç—É–ø.</li>
        <li><strong>2.</strong> –°—Ç–∞–Ω—å—Ç–µ —Ä—ñ–≤–Ω–æ, —Ä–æ–∑—Å–ª–∞–±—Ç–µ –æ–±–ª–∏—á—á—è, –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ö–∞–ª—ñ–±—Ä—É–≤–∞—Ç–∏ —Å–ø–æ–∫—ñ–π".</li>
        <li><strong>3.</strong> –í–∏–∫–æ–Ω—É–π—Ç–µ –º—ñ–º—ñ—á–Ω—ñ —Ä—É—Ö–∏: –ø—ñ–¥–Ω—ñ–º–∞–π—Ç–µ –±—Ä–æ–≤–∏, –ø—Ä–∏–º—É—Ä–∂—É–π—Ç–µ—Å—å, –ø–æ—Å–º—ñ—Ö–∞–π—Ç–µ—Å—å.</li>
        <li><strong>4.</strong> –°–ø–æ—Å—Ç–µ—Ä—ñ–≥–∞–π—Ç–µ –∑–∞ –∑–º—ñ–Ω–∞–º–∏ –∑–Ω–∞—á–µ–Ω—å —Ç–∞ –≥—Ä–∞—Ñ—ñ–∫–æ–º.</li>
        <li><strong>5.</strong> –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –∑–∞ —Å–µ—Å—ñ—é –ø–æ–∫–∞–∑—É—é—Ç—å—Å—è –ø—ñ–¥ –∫–æ–∂–Ω–æ—é –º–µ—Ç—Ä–∏–∫–æ—é.</li>
        <li><strong>6.</strong> –í–∏ –º–æ–∂–µ—Ç–µ –∑–±–µ—Ä–µ–≥—Ç–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏ (–º–∞–∫—Å–∏–º—É–º–∏) –≤ localStorage –∫–Ω–æ–ø–∫–æ—é "–ó–±–µ—Ä–µ–≥—Ç–∏ —Å–µ—Å—ñ—é".</li>
        <li><strong>7.</strong> –î–ª—è —Ñ–æ—Ç–æ "–¥–æ/–ø—ñ—Å–ª—è" –∑—Ä–æ–±—ñ—Ç—å –∑–Ω—ñ–º–∫–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏.</li>
      </ul>
    </div>
  </div>
  
  <div class="footer">
    <p>¬© 2025 | –ü—Ä–æ—Ç–æ—Ç–∏–ø –¥–ª—è –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥—ñ–≤ | –ù–∞ –æ—Å–Ω–æ–≤—ñ MediaPipe Face Mesh</p>
  </div>

  <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  
  <script>
    (function() {
      // ---------- DOM –µ–ª–µ–º–µ–Ω—Ç–∏ ----------
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const statusEl = document.getElementById('status');
      
      // –ú–µ—Ç—Ä–∏–∫–∏
      const browLeftValue = document.getElementById('browLeftValue');
      const browRightValue = document.getElementById('browRightValue');
      const eyeLeftValue = document.getElementById('eyeLeftValue');
      const eyeRightValue = document.getElementById('eyeRightValue');
      const mouthLeftValue = document.getElementById('mouthLeftValue');
      const mouthRightValue = document.getElementById('mouthRightValue');
      
      const browLeftMax = document.getElementById('browLeftMax');
      const browRightMax = document.getElementById('browRightMax');
      const eyeLeftMax = document.getElementById('eyeLeftMax');
      const eyeRightMax = document.getElementById('eyeRightMax');
      const mouthLeftMax = document.getElementById('mouthLeftMax');
      const mouthRightMax = document.getElementById('mouthRightMax');
      
      // –ö–Ω–æ–ø–∫–∏
      const startBtn = document.getElementById('startBtn');
      const calibrateBtn = document.getElementById('calibrateBtn');
      const resetMaxBtn = document.getElementById('resetMaxBtn');
      const saveSessionBtn = document.getElementById('saveSessionBtn');
      const photoBeforeBtn = document.getElementById('photoBeforeBtn');
      const photoAfterBtn = document.getElementById('photoAfterBtn');
      
      // –ì—Ä–∞—Ñ—ñ–∫
      const graphCanvas = document.getElementById('graphCanvas');
      const graphCtx = graphCanvas.getContext('2d');
      
      // ---------- –Ü–Ω–¥–µ–∫—Å–∏ —Ç–æ—á–æ–∫ (–∑ MediaPipe) ----------
      const IDX = {
        LEFT_EYE_OUTER: 33,      // –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –∫—É—Ç –ª—ñ–≤–æ–≥–æ –æ–∫–∞
        RIGHT_EYE_OUTER: 263,    // –∑–æ–≤–Ω—ñ—à–Ω—ñ–π –∫—É—Ç –ø—Ä–∞–≤–æ–≥–æ –æ–∫–∞
        LEFT_BROW: 105,          // –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –∫—Ä–∞–π –ª—ñ–≤–æ—ó –±—Ä–æ–≤–∏
        RIGHT_BROW: 334,         // –≤–Ω—É—Ç—Ä—ñ—à–Ω—ñ–π –∫—Ä–∞–π –ø—Ä–∞–≤–æ—ó –±—Ä–æ–≤–∏
        LEFT_EYE_UPPER: 34,      // –≤–µ—Ä—Ö–Ω—è –ø–æ–≤—ñ–∫–∞ –ª—ñ–≤–∞ (–∑–æ–≤–Ω—ñ—à–Ω—è —á–∞—Å—Ç–∏–Ω–∞)
        LEFT_EYE_LOWER: 94,      // –Ω–∏–∂–Ω—è –ø–æ–≤—ñ–∫–∞ –ª—ñ–≤–∞ (–∑–æ–≤–Ω—ñ—à–Ω—è —á–∞—Å—Ç–∏–Ω–∞)
        RIGHT_EYE_UPPER: 264,    // –≤–µ—Ä—Ö–Ω—è –ø–æ–≤—ñ–∫–∞ –ø—Ä–∞–≤–∞
        RIGHT_EYE_LOWER: 394,    // –Ω–∏–∂–Ω—è –ø–æ–≤—ñ–∫–∞ –ø—Ä–∞–≤–∞
        LEFT_MOUTH: 61,          // –ª—ñ–≤–∏–π –∫—É—Ç–æ—á–æ–∫ —Ä–æ—Ç–∞
        RIGHT_MOUTH: 291         // –ø—Ä–∞–≤–∏–π –∫—É—Ç–æ—á–æ–∫ —Ä–æ—Ç–∞
      };
      
      // ---------- –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ ----------
      let faceMesh = null;
      let camera = null;
      let isCameraRunning = false;
      
      // –ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è
      let shouldCalibrate = false;         // –ø—Ä–∞–ø–æ—Ä–µ—Ü—å, —â–æ –Ω–∞—Å—Ç—É–ø–Ω–µ –≤–∏—è–≤–ª–µ–Ω–Ω—è - –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è
      
      // –ë–∞–∑–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è (—Å—Ç–∞–Ω —Å–ø–æ–∫–æ—é)
      let baseline = {
        browLeftY: null,
        browRightY: null,
        eyeLeftDist: null,    // –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –≤–µ—Ä—Ö–Ω—å–æ—é —Ç–∞ –Ω–∏–∂–Ω—å–æ—é –ø–æ–≤—ñ–∫–æ—é (–ª—ñ–≤–µ –æ–∫–æ)
        eyeRightDist: null,
        mouthLeftY: null,
        mouthRightY: null,
        eyeDistance: null     // –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –∑–æ–≤–Ω—ñ—à–Ω—ñ–º–∏ –∫—É—Ç–∞–º–∏ –æ—á–µ–π (–¥–ª—è –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó)
      };
      
      // –ü–æ—Ç–æ—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è (–Ω–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ)
      let current = {
        browLeft: 0,
        browRight: 0,
        eyeLeft: 0,
        eyeRight: 0,
        mouthLeft: 0,
        mouthRight: 0
      };
      
      // –ú–∞–∫—Å–∏–º—É–º–∏
      let maxValues = {
        browLeft: 0,
        browRight: 0,
        eyeLeft: 0,
        eyeRight: 0,
        mouthLeft: 0,
        mouthRight: 0
      };
      
      // –Ü—Å—Ç–æ—Ä—ñ—è –¥–ª—è –≥—Ä–∞—Ñ—ñ–∫–∞ (–º–∞–∫—Å–∏–º—É–º 100 —Ç–æ—á–æ–∫)
      const historyLength = 100;
      let history = {
        browLeft: [],
        browRight: [],
        eyeLeft: [],
        eyeRight: [],
        mouthLeft: [],
        mouthRight: []
      };
      
      // –î–ª—è —Ñ–æ—Ç–æ
      let photoBeforeDataURL = null;
      let photoAfterDataURL = null;
      
      // ---------- –î–æ–ø–æ–º—ñ–∂–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó ----------
      function updateUI() {
        browLeftValue.textContent = current.browLeft.toFixed(3);
        browRightValue.textContent = current.browRight.toFixed(3);
        eyeLeftValue.textContent = current.eyeLeft.toFixed(3);
        eyeRightValue.textContent = current.eyeRight.toFixed(3);
        mouthLeftValue.textContent = current.mouthLeft.toFixed(3);
        mouthRightValue.textContent = current.mouthRight.toFixed(3);
        
        browLeftMax.textContent = maxValues.browLeft.toFixed(3);
        browRightMax.textContent = maxValues.browRight.toFixed(3);
        eyeLeftMax.textContent = maxValues.eyeLeft.toFixed(3);
        eyeRightMax.textContent = maxValues.eyeRight.toFixed(3);
        mouthLeftMax.textContent = maxValues.mouthLeft.toFixed(3);
        mouthRightMax.textContent = maxValues.mouthRight.toFixed(3);
      }
      
      // –î–æ–¥–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –¥–æ —ñ—Å—Ç–æ—Ä—ñ—ó
      function addToHistory() {
        for (let key in current) {
          if (history.hasOwnProperty(key)) {
            history[key].push(current[key]);
            if (history[key].length > historyLength) {
              history[key].shift();
            }
          }
        }
      }
      
      // –ú–∞–ª—é–≤–∞–Ω–Ω—è –≥—Ä–∞—Ñ—ñ–∫–∞
      function drawGraph() {
        graphCtx.clearRect(0, 0, graphCanvas.width, graphCanvas.height);
        if (history.browLeft.length === 0) return;
        
        const w = graphCanvas.width;
        const h = graphCanvas.height;
        const colors = {
          browLeft: '#d4a373',
          browRight: '#e8c66e',
          eyeLeft: '#ff7d00',
          eyeRight: '#ffaa00',
          mouthLeft: '#cbaacb',
          mouthRight: '#aaccdd'
        };
        
        // –ó–Ω–∞—Ö–æ–¥–∏–º–æ –º–∞–∫—Å–∏–º—É–º —Å–µ—Ä–µ–¥ —É—Å—ñ—Ö –∑–Ω–∞—á–µ–Ω—å –≤ —ñ—Å—Ç–æ—Ä—ñ—ó –¥–ª—è –º–∞—Å—à—Ç–∞–±—É–≤–∞–Ω–Ω—è –ø–æ Y
        let maxVal = 0.05; // –º—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω
        for (let key in history) {
          const arr = history[key];
          if (arr.length > 0) {
            const m = Math.max(...arr);
            if (m > maxVal) maxVal = m;
          }
        }
        if (maxVal < 0.01) maxVal = 0.01;
        
        const xStep = w / (historyLength - 1);
        
        // –ú–∞–ª—é—î–º–æ –ª—ñ–Ω—ñ—ó –¥–ª—è –∫–æ–∂–Ω–æ—ó –º–µ—Ç—Ä–∏–∫–∏
        for (let key in history) {
          const arr = history[key];
          if (arr.length < 2) continue;
          
          graphCtx.beginPath();
          graphCtx.strokeStyle = colors[key] || '#ffffff';
          graphCtx.lineWidth = 2;
          
          for (let i = 0; i < arr.length; i++) {
            const x = i * xStep;
            const y = h - (arr[i] / maxVal) * h * 0.9; // –∑–∞–ª–∏—à–∞—î–º–æ 10% –≤—ñ–¥—Å—Ç—É–ø—É –∑–≤–µ—Ä—Ö—É
            if (i === 0) graphCtx.moveTo(x, y);
            else graphCtx.lineTo(x, y);
          }
          graphCtx.stroke();
        }
      }
      
      // –°–∫–∏–¥–∞–Ω–Ω—è –º–∞–∫—Å–∏–º—É–º—ñ–≤
      function resetMax() {
        maxValues = {
          browLeft: 0,
          browRight: 0,
          eyeLeft: 0,
          eyeRight: 0,
          mouthLeft: 0,
          mouthRight: 0
        };
        updateUI();
      }
      
      // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞–∫—Å–∏–º—É–º—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ—Ç–æ—á–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω—å
      function updateMax() {
        if (current.browLeft > maxValues.browLeft) maxValues.browLeft = current.browLeft;
        if (current.browRight > maxValues.browRight) maxValues.browRight = current.browRight;
        if (current.eyeLeft > maxValues.eyeLeft) maxValues.eyeLeft = current.eyeLeft;
        if (current.eyeRight > maxValues.eyeRight) maxValues.eyeRight = current.eyeRight;
        if (current.mouthLeft > maxValues.mouthLeft) maxValues.mouthLeft = current.mouthLeft;
        if (current.mouthRight > maxValues.mouthRight) maxValues.mouthRight = current.mouthRight;
      }
      
      // ---------- –§—É–Ω–∫—Ü—ñ—è –æ–±—Ä–æ–±–∫–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ FaceMesh ----------
      function onResults(results) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
          const landmarks = results.multiFaceLandmarks[0];
          
          // –ú–∞–ª—é—î–º–æ –≤—Å—ñ —Ç–æ—á–∫–∏ —Å—ñ—Ä–∏–º –∫–æ–ª—å–æ—Ä–æ–º
          ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
          ctx.fillStyle = '#aaaaaa';
          ctx.strokeStyle = '#cccccc';
          ctx.lineWidth = 1;
          
          for (const point of landmarks) {
            const x = point.x * canvas.width;
            const y = point.y * canvas.height;
            ctx.beginPath();
            ctx.arc(x, y, 1.2, 0, 2 * Math.PI);
            ctx.fill();
          }
          
          // –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∫–ª—é—á–æ–≤–∏—Ö —Ç–æ—á–æ–∫
          const getPoint = (idx) => {
            const p = landmarks[idx];
            return { x: p.x * canvas.width, y: p.y * canvas.height };
          };
          
          try {
            const leftEyeOuter = getPoint(IDX.LEFT_EYE_OUTER);
            const rightEyeOuter = getPoint(IDX.RIGHT_EYE_OUTER);
            const browLeft = getPoint(IDX.LEFT_BROW);
            const browRight = getPoint(IDX.RIGHT_BROW);
            const leftEyeUpper = getPoint(IDX.LEFT_EYE_UPPER);
            const leftEyeLower = getPoint(IDX.LEFT_EYE_LOWER);
            const rightEyeUpper = getPoint(IDX.RIGHT_EYE_UPPER);
            const rightEyeLower = getPoint(IDX.RIGHT_EYE_LOWER);
            const mouthLeft = getPoint(IDX.LEFT_MOUTH);
            const mouthRight = getPoint(IDX.RIGHT_MOUTH);
            
            // –í—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –æ—á–∏–º–∞ (–¥–ª—è –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—ó)
            const eyeDistance = Math.hypot(rightEyeOuter.x - leftEyeOuter.x, rightEyeOuter.y - leftEyeOuter.y);
            
            // –Ø–∫—â–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è
            if (shouldCalibrate && eyeDistance > 0) {
              baseline.browLeftY = browLeft.y;
              baseline.browRightY = browRight.y;
              baseline.eyeLeftDist = Math.hypot(leftEyeUpper.x - leftEyeLower.x, leftEyeUpper.y - leftEyeLower.y);
              baseline.eyeRightDist = Math.hypot(rightEyeUpper.x - rightEyeLower.x, rightEyeUpper.y - rightEyeLower.y);
              baseline.mouthLeftY = mouthLeft.y;
              baseline.mouthRightY = mouthRight.y;
              baseline.eyeDistance = eyeDistance;
              
              shouldCalibrate = false;
              resetMax(); // —Å–∫–∏–¥–∞—î–º–æ –º–∞–∫—Å–∏–º—É–º–∏ –ø—Ä–∏ –Ω–æ–≤–æ–º—É –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—ñ
              statusEl.textContent = '‚úÖ –ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ–Ω–∞–Ω–æ. –¢–µ–ø–µ—Ä –≤–∏–∫–æ–Ω—É–π—Ç–µ —Ä—É—Ö–∏.';
            }
            
            // –Ø–∫—â–æ –±–∞–∑–æ–≤—ñ –∑–Ω–∞—á–µ–Ω–Ω—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ, –æ–±—á–∏—Å–ª—é—î–º–æ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å
            if (baseline.eyeDistance && baseline.eyeDistance > 0) {
              // –ù–æ—Ä–º–∞–ª—ñ–∑–æ–≤–∞–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è (–¥—ñ–ª–∏–º–æ –Ω–∞ –≤—ñ–¥—Å—Ç–∞–Ω—å –º—ñ–∂ –æ—á–∏–º–∞)
              const normFactor = baseline.eyeDistance;
              
              // –ë—Ä–æ–≤–∏: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–µ –∑–º—ñ—â–µ–Ω–Ω—è (–≤–≥–æ—Ä—É –¥–æ–¥–∞—Ç–Ω–µ)
              current.browLeft = Math.max(0, (baseline.browLeftY - browLeft.y) / normFactor);
              current.browRight = Math.max(0, (baseline.browRightY - browRight.y) / normFactor);
              
              // –û—á—ñ: –∑–º–µ–Ω—à–µ–Ω–Ω—è –≤—ñ–¥—Å—Ç–∞–Ω—ñ –º—ñ–∂ –≤–µ—Ä—Ö–Ω—å–æ—é —ñ –Ω–∏–∂–Ω—å–æ—é –ø–æ–≤—ñ–∫–æ—é (–ø—Ä–∏–º—É—Ä–∂—É–≤–∞–Ω–Ω—è)
              const eyeLeftDist = Math.hypot(leftEyeUpper.x - leftEyeLower.x, leftEyeUpper.y - leftEyeLower.y);
              const eyeRightDist = Math.hypot(rightEyeUpper.x - rightEyeLower.x, rightEyeUpper.y - rightEyeLower.y);
              current.eyeLeft = Math.max(0, (baseline.eyeLeftDist - eyeLeftDist) / normFactor);
              current.eyeRight = Math.max(0, (baseline.eyeRightDist - eyeRightDist) / normFactor);
              
              // –ö—É—Ç–æ—á–∫–∏ —Ä–æ—Ç–∞: –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–µ –ø—ñ–¥–Ω—è—Ç—Ç—è (—É—Å–º—ñ—à–∫–∞)
              current.mouthLeft = Math.max(0, (baseline.mouthLeftY - mouthLeft.y) / normFactor);
              current.mouthRight = Math.max(0, (baseline.mouthRightY - mouthRight.y) / normFactor);
              
              // –û–Ω–æ–≤–ª—é—î–º–æ –º–∞–∫—Å–∏–º—É–º–∏
              updateMax();
              
              // –î–æ–¥–∞—î–º–æ –≤ —ñ—Å—Ç–æ—Ä—ñ—é
              addToHistory();
              
              // –ú–∞–ª—é—î–º–æ –≥—Ä–∞—Ñ—ñ–∫
              drawGraph();
              
              // –í—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—è: –≤–∏–¥—ñ–ª—è—î–º–æ –∫–ª—é—á–æ–≤—ñ —Ç–æ—á–∫–∏ –±—ñ–ª—å—à–∏–º —Ä–æ–∑–º—ñ—Ä–æ–º –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
              ctx.fillStyle = '#ff7d00';
              ctx.strokeStyle = '#d4a373';
              ctx.lineWidth = 2;
              
              const drawHighlight = (pt, val) => {
                const x = pt.x, y = pt.y;
                const r = 5 + val * 100; // —Ä–æ–∑–º—ñ—Ä –ø—Ä–æ–ø–æ—Ä—Ü—ñ–π–Ω–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ
                ctx.beginPath();
                ctx.arc(x, y, r, 0, 2 * Math.PI);
                ctx.fillStyle = '#ff7d00';
                ctx.fill();
                ctx.strokeStyle = '#e8c66e';
                ctx.stroke();
              };
              
              drawHighlight(browLeft, current.browLeft);
              drawHighlight(browRight, current.browRight);
              drawHighlight(leftEyeUpper, current.eyeLeft);
              drawHighlight(rightEyeUpper, current.eyeRight);
              drawHighlight(mouthLeft, current.mouthLeft);
              drawHighlight(mouthRight, current.mouthRight);
            } else {
              statusEl.textContent = 'üòê –û–±–ª–∏—á—á—è –≤–∏—è–≤–ª–µ–Ω–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å "–ö–∞–ª—ñ–±—Ä—É–≤–∞—Ç–∏ —Å–ø–æ–∫—ñ–π".';
            }
            
            updateUI();
          } catch (e) {
            console.warn('–ü–æ–º–∏–ª–∫–∞ –æ–±—Ä–æ–±–∫–∏ —Ç–æ—á–æ–∫:', e);
          }
        } else {
          // –û–±–ª–∏—á—á—è –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ
          ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
          statusEl.textContent = 'üòï –û–±–ª–∏—á—á—è –Ω–µ –≤–∏—è–≤–ª–µ–Ω–æ.';
        }
      }
      
      // ---------- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è FaceMesh ----------
      function initFaceMesh() {
        faceMesh = new FaceMesh({
          locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`
        });
        
        faceMesh.setOptions({
          maxNumFaces: 1,
          refineLandmarks: true,
          minDetectionConfidence: 0.5,
          minTrackingConfidence: 0.5
        });
        
        faceMesh.onResults(onResults);
      }
      
      // ---------- –ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä–∏ ----------
      async function startCamera() {
        if (isCameraRunning) return;
        
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          video.srcObject = stream;
          
          await new Promise((resolve) => {
            video.onloadedmetadata = () => {
              video.play();
              resolve();
            };
          });
          
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          
          camera = new Camera(video, {
            onFrame: async () => {
              if (faceMesh) {
                await faceMesh.send({ image: video });
              }
            },
            width: video.videoWidth,
            height: video.videoHeight
          });
          
          camera.start();
          isCameraRunning = true;
          statusEl.textContent = 'üì∑ –ö–∞–º–µ—Ä—É –∑–∞–ø—É—â–µ–Ω–æ. –ß–µ–∫–∞—î–º–æ –Ω–∞ –æ–±–ª–∏—á—á—è...';
          startBtn.disabled = true;
          startBtn.style.opacity = 0.5;
        } catch (err) {
          statusEl.textContent = '‚ùå –ü–æ–º–∏–ª–∫–∞ –¥–æ—Å—Ç—É–ø—É –¥–æ –∫–∞–º–µ—Ä–∏: ' + err.message;
        }
      }
      
      // ---------- –ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è ----------
      function calibrate() {
        if (!isCameraRunning) {
          statusEl.textContent = '‚ö†Ô∏è –°–ø–æ—á–∞—Ç–∫—É –∑–∞–ø—É—Å—Ç—ñ—Ç—å –∫–∞–º–µ—Ä—É.';
          return;
        }
        shouldCalibrate = true;
        statusEl.textContent = '‚öôÔ∏è –ö–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—è... –ó–∞—Ñ—ñ–∫—Å—É–π—Ç–µ —Å–ø–æ–∫—ñ–π–Ω–∏–π –≤–∏—Ä–∞–∑ –æ–±–ª–∏—á—á—è.';
      }
      
      // ---------- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å–µ—Å—ñ—ó –≤ localStorage ----------
      function saveSession() {
        const session = {
          timestamp: new Date().toISOString(),
          maxValues: { ...maxValues }
        };
        
        let sessions = JSON.parse(localStorage.getItem('facial_sessions') || '[]');
        sessions.push(session);
        localStorage.setItem('facial_sessions', JSON.stringify(sessions));
        
        alert('‚úÖ –°–µ—Å—ñ—é –∑–±–µ—Ä–µ–∂–µ–Ω–æ –≤ localStorage!');
      }
      
      // ---------- –§–æ—Ç–æ –¥–æ/–ø—ñ—Å–ª—è ----------
      function takePhoto(target) {
        if (!isCameraRunning) {
          alert('–ö–∞–º–µ—Ä–∞ –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞!');
          return;
        }
        // –†–æ–±–∏–º–æ –∑–Ω—ñ–º–æ–∫ –∑ canvas (–Ω–∞ —è–∫–æ–º—É –≤–∂–µ —î —Ä–æ–∑–º—ñ—Ç–∫–∞)
        const dataURL = canvas.toDataURL('image/png');
        if (target === 'before') {
          photoBeforeDataURL = dataURL;
          document.getElementById('photoBefore').src = dataURL;
        } else {
          photoAfterDataURL = dataURL;
          document.getElementById('photoAfter').src = dataURL;
        }
      }
      
      // ---------- –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π ----------
      startBtn.addEventListener('click', startCamera);
      calibrateBtn.addEventListener('click', calibrate);
      resetMaxBtn.addEventListener('click', resetMax);
      saveSessionBtn.addEventListener('click', saveSession);
      photoBeforeBtn.addEventListener('click', () => takePhoto('before'));
      photoAfterBtn.addEventListener('click', () => takePhoto('after'));
      
      // ---------- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ ----------
      initFaceMesh();
      
      window.addEventListener('beforeunload', () => {
        if (camera) camera.stop();
        if (video.srcObject) {
          video.srcObject.getTracks().forEach(track => track.stop());
        }
      });
      
      // –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –≥—Ä–∞—Ñ—ñ–∫–∞ –ø—Ä–∏ –∫–∞–ª—ñ–±—Ä—É–≤–∞–Ω–Ω—ñ (–¥–æ–¥–∞—Ç–∫–æ–≤–æ)
      // –î–ª—è —Ü—å–æ–≥–æ –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ –≤ calibrate —Å–∫–∏–¥–∞–Ω–Ω—è —ñ—Å—Ç–æ—Ä—ñ—ó:
      const originalCalibrate = calibrate;
      calibrate = function() {
        originalCalibrate();
        // –û—á–∏—Å—Ç–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é
        for (let key in history) {
          history[key] = [];
        }
        drawGraph();
      };
      calibrateBtn.removeEventListener('click', calibrate);
      calibrateBtn.addEventListener('click', calibrate);
      
    })();
  </script>
</body>
</html>
