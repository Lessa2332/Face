<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Weather: Realistic Physics</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; }
        #input_video {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; object-fit: cover;
            z-index: 1;
            /* ВИДАЛЕНО transform: scaleX(-1) для правильної орієнтації */
        }
        canvas { position: absolute; top: 0; left: 0; z-index: 2; pointer-events: none; }
        #ui-layer { 
            position: absolute; top: 40px; left: 20px; color: #fff; z-index: 10; 
            font-family: sans-serif; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: #111; z-index: 100; color: #64b5f6;
        }
        .btn { padding: 15px 30px; border: 2px solid #64b5f6; background: none; color: #64b5f6; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div id="overlay">
        <button class="btn" onclick="start()">ЗАПУСТИТИ ДОЩ</button>
    </div>

    <div id="ui-layer">
        <h1 style="margin:0; color:#64b5f6;">3D WEATHER LAB</h1>
        <p id="status">Очікування активації...</p>
    </div>

    <video id="input_video" autoplay playsinline muted></video>

    <script>
        const videoElement = document.getElementById('input_video');
        const statusText = document.getElementById('status');

        // --- 1. THREE.JS НАЛАШТУВАННЯ ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // Освітлення для об'єму крапель
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(0, 10, 10);
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));

        // --- 2. ГЕОМЕТРІЯ КРАПЛІ (3D КОНУС) ---
        const rainCount = 400; // Менше, бо 3D важче для процесора
        const rainDrops = [];
        const dropGeometry = new THREE.ConeGeometry(0.015, 0.15, 4); // Об'ємна крапля
        const dropMaterial = new THREE.MeshPhongMaterial({ 
            color: 0x64b5f6, 
            transparent: true, 
            opacity: 0.8,
            shininess: 100 
        });

        for (let i = 0; i < rainCount; i++) {
            const drop = new THREE.Mesh(dropGeometry, dropMaterial);
            resetDrop(drop);
            scene.add(drop);
            rainDrops.push({
                mesh: drop,
                velocity: new THREE.Vector3(0, -0.1 - Math.random() * 0.1, 0),
                isSplashing: false
            });
        }

        function resetDrop(drop) {
            drop.position.set((Math.random() - 0.5) * 8, 5 + Math.random() * 5, (Math.random() - 0.5) * 4);
            drop.rotation.x = Math.PI; // Носиком вниз
        }

        camera.position.z = 5;

        // --- 3. ТРЕКІНГ РУКИ ---
        let handPos = null;
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        
        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0][9];
                // ВИПРАВЛЕНО: Пряме відображення координат (lm.x замість 0.5-lm.x)
                handPos = {
                    x: (lm.x - 0.5) * 10, 
                    y: -(lm.y - 0.5) * 8,
                    z: 0
                };
                statusText.innerText = "Рука активна: ловіть краплі!";
            } else {
                handPos = null;
                statusText.innerText = "Покажіть долоню";
            }
        });

        async function start() {
            document.getElementById('overlay').style.display = 'none';
            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 1280, height: 720, facingMode: 'environment'
            });
            cameraUtils.start();
            animate();
        }

        // --- 4. ФІЗИКА ТА АНІМАЦІЯ ---
        function animate() {
            requestAnimationFrame(animate);
            
            rainDrops.forEach(dropObj => {
                const d = dropObj.mesh;
                const v = dropObj.velocity;

                d.position.add(v);

                // Перевірка зіткнення з рукою
                if (handPos) {
                    const dist = d.position.distanceTo(new THREE.Vector3(handPos.x, handPos.y, d.position.z));
                    
                    if (dist < 0.6 && d.position.y > handPos.y - 0.3 && d.position.y < handPos.y + 0.3) {
                        // ВІДБИТТЯ (ВІДСКОК)
                        v.y = Math.abs(v.y) * 1.2; // Відлітає вгору швидше
                        v.x = (d.position.x - handPos.x) * 0.3; // Вбік від долоні
                        d.rotation.z += 0.5; // Крапля починає крутитися при ударі
                        
                        // Зміна кольору при ударі (ефект іскри)
                        d.material.color.setHex(0xffffff);
                        setTimeout(() => d.material.color.setHex(0x64b5f6), 100);
                    }
                }

                // Повернення якщо впала занадто низько або полетіла вгору після відскоку
                if (d.position.y < -5 || d.position.y > 10) {
                    resetDrop(d);
                    v.y = -0.1 - Math.random() * 0.1;
                    v.x = 0;
                    d.rotation.z = 0;
                }
            });

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>

