<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AR Weather Station: Rain Gauge</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; }
        #input_video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        canvas { position: absolute; top: 0; left: 0; z-index: 2; pointer-events: none; }
        
        #ui-layer { 
            position: absolute; top: 30px; left: 20px; color: #fff; z-index: 10; 
            background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px;
            border-left: 5px solid #64b5f6; backdrop-filter: blur(5px);
        }
        .stats { font-size: 24px; font-weight: bold; color: #64b5f6; margin-top: 5px; }
        
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            background: #111; z-index: 100;
        }
        .btn { 
            padding: 15px 40px; border: 2px solid #64b5f6; background: none; 
            color: #64b5f6; border-radius: 30px; cursor: pointer; font-weight: bold;
            transition: 0.3s;
        }
        .btn:hover { background: #64b5f6; color: white; }
    </style>
</head>
<body>

    <div id="overlay">
        <button class="btn" onclick="start()">АКТИВУВАТИ ДОЩОМІР</button>
    </div>

    <div id="ui-layer">
        <div style="font-size: 12px; opacity: 0.8; text-transform: uppercase;">Метеостанція: Плювіограф</div>
        <div id="status" class="stats">0.00 mm</div>
        <div style="font-size: 10px; color: #aaa;">Тримайте долоню горизонтально</div>
    </div>

    <video id="input_video" autoplay playsinline muted></video>

    <script>
        const videoElement = document.getElementById('input_video');
        const statusText = document.getElementById('status');

        let rainLevel = 0; // Накопичена вода в мм

        // --- 1. THREE.JS: СЦЕНА ТА ОБ'ЄКТИ ---
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        // --- СТВОРЕННЯ ДОЩОМІРА (Група об'єктів) ---
        const gaugeGroup = new THREE.Group();
        scene.add(gaugeGroup);

        // Скляна колба
        const glassGeo = new THREE.CylinderGeometry(0.4, 0.4, 1.5, 32, 1, true);
        const glassMat = new THREE.MeshPhongMaterial({ 
            color: 0xffffff, transparent: true, opacity: 0.3, side: THREE.DoubleSide, shininess: 100 
        });
        const glass = new THREE.Mesh(glassGeo, glassMat);
        gaugeGroup.add(glass);

        // Вода всередині
        const waterGeo = new THREE.CylinderGeometry(0.39, 0.39, 1.5, 32);
        const waterMat = new THREE.MeshPhongMaterial({ color: 0x00aaff, transparent: true, opacity: 0.7 });
        const water = new THREE.Mesh(waterGeo, waterMat);
        water.position.y = -0.75; // Дно колби
        water.scale.set(1, 0.01, 1); // Починаємо з майже нуля
        gaugeGroup.add(water);

        // Шкала (прості мітки)
        for(let i=1; i<=5; i++) {
            const markGeo = new THREE.BoxGeometry(0.2, 0.02, 0.1);
            const mark = new THREE.Mesh(markGeo, new THREE.MeshBasicMaterial({color: 0xffffff}));
            mark.position.set(0.4, -0.75 + (i * 0.25), 0);
            gaugeGroup.add(mark);
        }

        // --- СИСТЕМА ДОЩУ ---
        const rainCount = 300;
        const rainDrops = [];
        const dropGeo = new THREE.ConeGeometry(0.01, 0.1, 4);
        const dropMat = new THREE.MeshBasicMaterial({ color: 0x64b5f6, transparent: true, opacity: 0.6 });

        for (let i = 0; i < rainCount; i++) {
            const drop = new THREE.Mesh(dropGeo, dropMat);
            resetDrop(drop);
            scene.add(drop);
            rainDrops.push({ mesh: drop, velocity: -0.1 - Math.random() * 0.1 });
        }

        function resetDrop(drop) {
            drop.position.set((Math.random() - 0.5) * 10, 6 + Math.random() * 5, (Math.random() - 0.5) * 5);
        }

        camera.position.z = 5;

        // --- 2. ТРЕКІНГ РУКИ ---
        let handPos = null;
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        
        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0][9]; // Центр долоні
                handPos = {
                    x: (lm.x - 0.5) * 12, 
                    y: -(lm.y - 0.5) * 8,
                    z: (lm.z * 10) 
                };
            } else {
                handPos = null;
            }
        });

        async function start() {
            document.getElementById('overlay').style.display = 'none';
            const cameraUtils = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 1280, height: 720
            });
            cameraUtils.start();
            animate();
        }

        // --- 3. ФІЗИКА НАПОВНЕННЯ ---
        function animate() {
            requestAnimationFrame(animate);
            
            if (handPos) {
                // Дощомір плавно слідує за рукою
                gaugeGroup.position.lerp(new THREE.Vector3(handPos.x, handPos.y, 0), 0.2);
            }

            rainDrops.forEach(dropObj => {
                const d = dropObj.mesh;
                d.position.y += dropObj.velocity;

                if (handPos) {
                    // Радіус колізії (вхід в колбу)
                    const dx = d.position.x - gaugeGroup.position.x;
                    const dz = d.position.z - gaugeGroup.position.z;
                    const distXZ = Math.sqrt(dx*dx + dz*dz);

                    // Якщо крапля потрапила в радіус колби і знаходиться на рівні її верхньої частини
                    if (distXZ < 0.4 && d.position.y < gaugeGroup.position.y + 0.7 && d.position.y > gaugeGroup.position.y) {
                        
                        // ЛОГІКА НАКОПИЧЕННЯ
                        rainLevel += 0.002; 
                        statusText.innerText = (rainLevel * 10).toFixed(2) + " mm";
                        
                        // Оновлення візуального рівня води
                        const visualScale = Math.min(rainLevel * 5, 1); 
                        water.scale.y = visualScale;
                        water.position.y = -0.75 + (0.75 * visualScale);

                        resetDrop(d); // Крапля "зникла" в колбі
                    }
                }

                if (d.position.y < -5) resetDrop(d);
            });

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
