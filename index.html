<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Beauty AI | PDF Report Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --accent: #00ffcc; --danger: #ff3030; --panel-bg: rgba(10, 10, 10, 0.9); }
        body { margin: 0; background: #000; color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #container { position: relative; width: 100vw; height: 100vh; }
        video, canvas { position: absolute; width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }

        .side-panel { 
            position: absolute; right: 20px; top: 50%; transform: translateY(-50%); 
            background: var(--panel-bg); padding: 20px; border-radius: 24px; 
            border: 1px solid rgba(0, 255, 204, 0.3); width: 260px; z-index: 20;
        }

        .mertz-box { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 15px; text-align: center; margin-bottom: 15px; border: 1px solid var(--accent); }
        .mertz-val { font-size: 2.5rem; font-weight: 800; color: var(--accent); }
        
        button { background: rgba(255,255,255,0.1); border: 1px solid var(--accent); color: white; padding: 12px; width: 100%; border-radius: 12px; margin-top: 8px; cursor: pointer; transition: 0.3s; }
        button.active { background: var(--accent); color: black; font-weight: bold; }
        
        #capture-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; z-index: 100; pointer-events: none; }
        
        .brand-logo { width: 50px; margin-bottom: 10px; }
    </style>
</head>
<body>

    <div id="capture-flash"></div>

    <div id="container">
        <video id="webcam" autoplay playsinline></video>
        <canvas id="output_canvas"></canvas>
        
        <div class="side-panel">
            <img src="logo.png" alt="Smart Beauty" class="brand-logo" onerror="this.style.display='none'">
            <div class="mertz-box">
                <span style="font-size: 0.7rem; opacity: 0.7; text-transform: uppercase;">–®–∫–∞–ª–∞ Mertz</span>
                <div id="mertz-display" class="mertz-val">0</div>
            </div>

            <button id="btn-botox">–°–∏–º—É–ª—è—Ü—ñ—è Botox (AR)</button>
            <button id="btn-anatomy">–ê–Ω–∞—Ç–æ–º—ñ—á–Ω–∞ —Å—ñ—Ç–∫–∞</button>
            <button id="btn-pdf" style="background: var(--accent); color: #000; font-weight: bold; margin-top: 20px;">üìÑ –ì–ï–ù–ï–†–£–í–ê–¢–ò PDF –ó–í–Ü–¢</button>
        </div>
    </div>

    <script type="module">
        import { FaceLandmarker, FilesetResolver, DrawingUtils } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

        const { jsPDF } = window.jspdf;
        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("2d");
        
        let faceLandmarker;
        let botoxMode = false;
        let anatomyMode = false;
        let currentMertz = 0;
        let currentLandmarks = null;

        async function init() {
            const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
            faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
                baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`, delegate: "GPU" },
                outputFaceBlendshapes: true, runningMode: "VIDEO", numFaces: 1
            });
            navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } }).then(s => {
                video.srcObject = s;
                video.addEventListener("loadeddata", renderLoop);
            });
        }

        async function renderLoop() {
            canvasElement.width = video.videoWidth;
            canvasElement.height = video.videoHeight;

            const results = faceLandmarker.detectForVideo(video, performance.now());
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

            if (results.faceLandmarks && results.faceLandmarks.length > 0) {
                currentLandmarks = results.faceLandmarks[0];
                const blendshapes = results.faceBlendshapes[0].categories;
                
                // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ Mertz
                const browDown = blendshapes.find(b => b.categoryName === "browDownLeft").score + 
                                 blendshapes.find(b => b.categoryName === "browDownRight").score;
                currentMertz = Math.min(Math.round(browDown * 4), 4);
                document.getElementById("mertz-display").innerText = currentMertz;

                const draw = new DrawingUtils(canvasCtx);
                if (anatomyMode) draw.drawConnectors(currentLandmarks, FaceLandmarker.FACE_LANDMARKS_TESSELATION, { color: "#ffffff30" });

                if (botoxMode) {
                    applyBotoxEffect(currentLandmarks);
                }
            }
            requestAnimationFrame(renderLoop);
        }

        function applyBotoxEffect(landmarks) {
            canvasCtx.save();
            canvasCtx.filter = "blur(15px) brightness(1.1)";
            canvasCtx.fillStyle = "rgba(255, 255, 255, 0.2)";
            const forehead = [10, 338, 297, 332, 284, 251, 21, 54, 103, 67, 10];
            canvasCtx.beginPath();
            forehead.forEach((idx, i) => {
                const x = landmarks[idx].x * canvasElement.width;
                const y = landmarks[idx].y * canvasElement.height;
                if (i === 0) canvasCtx.moveTo(x, y); else canvasCtx.lineTo(x, y);
            });
            canvasCtx.fill();
            canvasCtx.restore();
        }

        // –ö–Ω–æ–ø–∫–∞ PDF
        document.getElementById("btn-pdf").onclick = async () => {
            const flash = document.getElementById("capture-flash");
            flash.style.display = "block";
            setTimeout(() => flash.style.display = "none", 100);

            // 1. –ó–∞—Ö–æ–ø–ª—é—î–º–æ "–î–æ" (–±–µ–∑ –µ—Ñ–µ–∫—Ç—ñ–≤)
            const oldBotox = botoxMode;
            botoxMode = false;
            await new Promise(r => setTimeout(r, 100));
            const imgBefore = captureFrame();

            // 2. –ó–∞—Ö–æ–ø–ª—é—î–º–æ "–ü—ñ—Å–ª—è" (–∑ –µ—Ñ–µ–∫—Ç–æ–º)
            botoxMode = true;
            await new Promise(r => setTimeout(r, 100));
            const imgAfter = captureFrame();
            botoxMode = oldBotox;

            // 3. –°—Ç–≤–æ—Ä—é—î–º–æ PDF
            const doc = new jsPDF();
            
            // –î–æ–¥–∞—î–º–æ –ª–æ–≥–æ
            try { doc.addImage('logo.png', 'PNG', 15, 10, 20, 20); } catch(e) {}
            
            doc.setFontSize(22);
            doc.text("Smart Beauty Diagnostic Report", 40, 25);
            
            doc.setFontSize(12);
            doc.text(`–î–∞—Ç–∞: ${new Date().toLocaleDateString()}`, 15, 40);
            doc.text(`–°—Ç—É–ø—ñ–Ω—å –≥—ñ–ø–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—ñ (Mertz): ${currentMertz}/4`, 15, 48);
            
            doc.setFontSize(14);
            doc.text("–î–û (–ê–∫—Ç–∏–≤–Ω–∞ –º—ñ–º—ñ–∫–∞)", 15, 65);
            doc.addImage(imgBefore, 'JPEG', 15, 70, 85, 110);
            
            doc.text("–ü–Ü–°–õ–Ø (–°–∏–º—É–ª—è—Ü—ñ—è Botox)", 110, 65);
            doc.addImage(imgAfter, 'JPEG', 110, 70, 85, 110);
            
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text("–¶–µ–π –∑–≤—ñ—Ç —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ AI Smart Beauty. –ù–µ —î –º–µ–¥–∏—á–Ω–∏–º –≤–∏—Å–Ω–æ–≤–∫–æ–º.", 15, 190);

            doc.save(`SmartBeauty_Report_${Date.now()}.pdf`);
        };

        function captureFrame() {
            const tempCanvas = document.createElement("canvas");
            tempCanvas.width = canvasElement.width;
            tempCanvas.height = canvasElement.height;
            const ctx = tempCanvas.getContext("2d");
            
            // –ú–∞–ª—é—î–º–æ –≤—ñ–¥–µ–æ + –æ–≤–µ—Ä–ª–µ–π
            ctx.scale(-1, 1);
            ctx.drawImage(video, -tempCanvas.width, 0, tempCanvas.width, tempCanvas.height);
            ctx.scale(-1, 1);
            ctx.drawImage(canvasElement, 0, 0);
            
            return tempCanvas.toDataURL("image/jpeg", 0.8);
        }

        document.getElementById("btn-botox").onclick = (e) => {
            botoxMode = !botoxMode;
            e.target.classList.toggle("active");
        };
        document.getElementById("btn-anatomy").onclick = (e) => {
            anatomyMode = !anatomyMode;
            e.target.classList.toggle("active");
        };

        init();
    </script>
</body>
</html>
