<!DOCTYPE html>
<html>
<head>
    <title>AR Weather: Master of Rain</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { margin: 0; background: #0f0f0f; overflow: hidden; font-family: 'Cormorant Garamond', serif; }
        #ui-layer { position: absolute; top: 20px; left: 20px; color: #d4a373; pointer-events: none; z-index: 10; }
        canvas { display: block; }
    </style>
</head>
<body>
    <div id="ui-layer">
        <h1 style="letter-spacing: 3px;">ЕЛЕМЕНТАЛЬ: ДОЩ</h1>
        <p id="status">Очікування мага...</p>
    </div>
    <video id="input_video" style="display:none"></video>

    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // --- Налаштування часток ---
        const rainCount = 2000;
        const rainGeo = new THREE.BufferGeometry();
        const rainPos = new Float32Array(rainCount * 3);
        const rainSpeeds = new Float32Array(rainCount); // Індивідуальна швидкість

        for(let i=0; i<rainCount; i++) {
            rainPos[i*3] = (Math.random() - 0.5) * 12;
            rainPos[i*3+1] = Math.random() * 10; // Зона 1: Початок (хмара)
            rainPos[i*3+2] = (Math.random() - 0.5) * 5;
            rainSpeeds[i] = 0.05 + Math.random() * 0.15; // Різна швидкість крапель
        }

        rainGeo.setAttribute('position', new THREE.BufferAttribute(rainPos, 3));
        const rainMat = new THREE.PointsMaterial({ 
            color: 0xd4a373, 
            size: 0.025, 
            transparent: true, 
            opacity: 0 // Початково невидимий
        });
        const rainPoints = new THREE.Points(rainGeo, rainMat);
        scene.add(rainPoints);

        camera.position.z = 5;

        let handPos = null;

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });
        
        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0][9];
                handPos = { x: (lm.x - 0.5) * 12, y: -(lm.y - 0.5) * 10, z: 0 };
                document.getElementById('status').innerText = "Магія активна";
            } else {
                handPos = null;
                document.getElementById('status').innerText = "Піднесіть руку для виклику дощу";
            }
        });

        function animate() {
            requestAnimationFrame(animate);
            const pos = rainGeo.attributes.position.array;

            // Логіка появи: дощ видимий тільки коли є рука
            if (handPos) {
                rainMat.opacity = Math.min(0.7, rainMat.opacity + 0.02);
            } else {
                rainMat.opacity = Math.max(0, rainMat.opacity - 0.02);
            }

            for (let i = 0; i < rainCount; i++) {
                let idx = i * 3;
                
                // ЗОНА 1: ПАДІННЯ (ВІД ХМАРИ)
                pos[idx + 1] -= rainSpeeds[i]; 

                // ЗОНА 2: ВЗАЄМОДІЯ (РУКА)
                if (handPos) {
                    // Перевіряємо близькість до долоні
                    let dx = pos[idx] - handPos.x;
                    let dy = pos[idx + 1] - handPos.y;
                    let dist = Math.sqrt(dx*dx + dy*dy);

                    if (dist < 0.8) { 
                        // Крапля "розбивається" об руку
                        pos[idx + 1] += 0.4; // Відскок вгору
                        pos[idx] += (Math.random() - 0.5) * 1.5; // Бризк в сторони
                    }
                }

                // ЗОНА 3: ЗЕМЛЯ (МЕЖА)
                // Якщо крапля впала нижче умовної підлоги
                if (pos[idx + 1] < -4) {
                    pos[idx + 1] = 6; // Повернення в "хмару" на висоту
                    pos[idx] = (Math.random() - 0.5) * 12; // Нове місце появи
                }
            }
            
            rainGeo.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }

        const videoElement = document.getElementById('input_video');
        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 1280, height: 720
        });
        cameraUtils.start();
        animate();
    </script>
</body>
</html>
